name: Update all list
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 1 *'  #ÊØéÊúà1Êó•0ÊôÇÂÆüÊñΩ

jobs:
  update-all-list:
    runs-on: ubuntu-latest
    steps:

      - name: Setup Node üìã
        uses: actions/setup-node@v1
        with:
          node-version: "20.10.x"

      - name: Install m3u-linter üìã
        run: |
          npm install -g m3u-linter || true

      - name: Install iptv-checker üìã
        run: |
          npm install -g iptv-checker || true
          sudo apt-get install -y ffmpeg

      # local
      - name: 1-0. Checkout local repo üêæ
        uses: actions/checkout@v4
        with:
          ref: main
          path: local

#      # remote 1
#      - name: 1-1. Checkout remote repo@iptv-org/iptv üöÄ
#        uses: actions/checkout@v4
#        with:
#          repository: iptv-org/iptv
#          ref: gh-pages
#          path: remote1
#      - name: 1-2. Copy files üöö
#        run: |
#          cd ${GITHUB_WORKSPACE}/local/work/
#          rm -rf *
#          cp -rfp ${GITHUB_WORKSPACE}/remote1/*  ${GITHUB_WORKSPACE}/local/work/
#          ls -lat | sort -s -k 1,1
#      - name: 1-3. Check files üî•
#        run: |
#          m3u-linter -c ${GITHUB_WORKSPACE}/local/M3u-linter.config.json ${GITHUB_WORKSPACE}/local/work/playlist.m3u8
#          iptv-checker -o ${GITHUB_WORKSPACE}/local/output -p 100 -t 60000 ${GITHUB_WORKSPACE}/local/work/playlist.m3u8
#          cp -pr ${GITHUB_WORKSPACE}/local/output/online.m3u ${GITHUB_WORKSPACE}/local/api/playlist.m3u8



      # remote 2
      - name: 2-1. Checkout remote repo@Free-TV/IPTV üöÄ
        uses: actions/checkout@v4
        with:
          repository: Free-TV/IPTV
          ref: master
          path: remote2
      - name: 2-2. Copy files üöö
        run: |
          cd ${GITHUB_WORKSPACE}/local/work/
          rm -rf *
          cp -rfp ${GITHUB_WORKSPACE}/remote2/lists      ${GITHUB_WORKSPACE}/local/api/
          cp -rfp ${GITHUB_WORKSPACE}/remote2/playlists  ${GITHUB_WORKSPACE}/local/work/
          cp -rfp ${GITHUB_WORKSPACE}/remote2/*.m3u*     ${GITHUB_WORKSPACE}/local/work/
          ls -lat | sort -s -k 1,1
      - name: 2-3. Check files üî•
        run: |
          function read_dir(){
            for file in `ls $1`
            do
              if [ -d $1"/"$file ]  #Ê≥®ÊÑèÊ≠§Â§Ñ‰πãÈó¥‰∏ÄÂÆöË¶ÅÂä†‰∏äÁ©∫Ê†ºÔºåÂê¶Âàô‰ºöÊä•Èîô
              then  
                read_dir $1"/"$file
              else
                echo $1"/"$file
                iptv-checker -o ${GITHUB_WORKSPACE}/local/output -p 100 -t 60000 $1"/"$file
                cp -pr ${GITHUB_WORKSPACE}/local/output/online.m3u ${GITHUB_WORKSPACE}/local/api/$file
              fi
            done
          }
          read_dir ${GITHUB_WORKSPACE}/local/work


#      # remote 3
#      - name: 3-1 .Checkout remote repo@imDazui/Tvlist-awesome-m3u-m3u8 üöÄ
#        uses: actions/checkout@v4
#        with:
#          repository: imDazui/Tvlist-awesome-m3u-m3u8
#          ref: master
#          path: remote3
#      - name: 3-2. Copy files üöö
#        run: |
#          cd ${GITHUB_WORKSPACE}/local/work/
#          rm -rf *
#          mkdir   ${GITHUB_WORKSPACE}/local/work/imDazui/
#          cp -rfp ${GITHUB_WORKSPACE}/remote3/m3u/*.m3u*  ${GITHUB_WORKSPACE}/local/work/imDazui/
#          ls -lat | sort -s -k 1,1
#      - name: 3-3. Check files üî•
#        run: |
#          m3u-linter -c ${GITHUB_WORKSPACE}/local/M3u-linter.config.json ${GITHUB_WORKSPACE}/local/work/playlist.m3u8
#          iptv-checker -o ${GITHUB_WORKSPACE}/local/output -p 100 -t 60000 ${GITHUB_WORKSPACE}/local/work/playlist.m3u8
#          cp -pr ${GITHUB_WORKSPACE}/local/output/online.m3u ${GITHUB_WORKSPACE}/local/api/playlist.m3u8



#      # remote 4
#      - name: 4-1. Checkout remote repo@fanmingming/live üöÄ
#        uses: actions/checkout@v4
#        with:
#          repository: fanmingming/live
#          ref: main
#          path: remote4
#      - name: 4-2. Copy files üöö
#        run: |
#          cd ${GITHUB_WORKSPACE}/local/work/
#          rm -rf *
#          mkdir   ${GITHUB_WORKSPACE}/local/work/tv/
#          mkdir   ${GITHUB_WORKSPACE}/local/work/radio/
#          cp -rfp ${GITHUB_WORKSPACE}/remote4/tv/m3u/*.m3u*     ${GITHUB_WORKSPACE}/local/work/tv/
#          cp -rfp ${GITHUB_WORKSPACE}/remote4/radio/m3u/*.m3u*  ${GITHUB_WORKSPACE}/local/work/radio/
#          ls -lat | sort -s -k 1,1
#      - name: 4-3. Check files üî•
#        run: |
#          m3u-linter -c ${GITHUB_WORKSPACE}/local/M3u-linter.config.json ${GITHUB_WORKSPACE}/local/work/playlist.m3u8
#          iptv-checker -o ${GITHUB_WORKSPACE}/local/output -p 100 -t 60000 ${GITHUB_WORKSPACE}/local/work/playlist.m3u8
#          cp -pr ${GITHUB_WORKSPACE}/local/output/online.m3u ${GITHUB_WORKSPACE}/local/api/playlist.m3u8


      - name: Commit & Push changes üî•
        uses: Andro999b/push@v1.3
        with:
          branch: main
          directory: ${{ github.workspace }}/local/
          github_token: ${{ secrets.GITHUB_TOKEN }}
          message: 'üöÄ auto publish by bot'
